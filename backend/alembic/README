Alembic Database Migration Tool
===============================

This directory contains Alembic migrations for the Werewolf AI Game database.

## Quick Start

### 1. Install Alembic (if not already installed)

```bash
pip install alembic==1.13.1
```

### 2. Create a New Migration

Auto-generate migration from model changes:
```bash
alembic revision --autogenerate -m "description of changes"
```

Create empty migration:
```bash
alembic revision -m "description of changes"
```

### 3. Apply Migrations

Upgrade to latest version:
```bash
alembic upgrade head
```

Upgrade to specific version:
```bash
alembic upgrade <revision_id>
```

### 4. Rollback Migrations

Downgrade one version:
```bash
alembic downgrade -1
```

Downgrade to specific version:
```bash
alembic downgrade <revision_id>
```

### 5. View Migration History

```bash
alembic history
```

Current version:
```bash
alembic current
```

## Configuration

- **alembic.ini**: Main configuration file (database URL, logging, etc.)
- **env.py**: Environment configuration (connects to app models)
- **script.py.mako**: Template for new migration files
- **versions/**: Directory containing all migration scripts

## Database URL

By default, Alembic uses the database URL from `alembic.ini`:
```ini
sqlalchemy.url = sqlite:///data/werewolf.db
```

For production, you can override this with an environment variable:
```bash
export DATABASE_URL=postgresql://user:pass@localhost/werewolf
```

## Best Practices

1. **Always review auto-generated migrations** before applying them
2. **Test migrations** on a copy of production data before deploying
3. **Write downgrade functions** for all migrations (for rollback capability)
4. **Commit migration files** to version control
5. **Never modify existing migrations** that have been applied to production

## Common Commands

```bash
# Initialize database version tracking (first time only)
alembic stamp head

# Check for pending migrations
alembic current
alembic history

# Dry-run migration (show SQL without executing)
alembic upgrade head --sql

# Generate SQL script instead of applying directly
alembic upgrade head --sql > migration.sql
```

## Troubleshooting

**Error: "Can't locate revision identified by 'xxx'"**
- Run `alembic stamp head` to mark current database version

**Error: "Target database is not up to date"**
- Run `alembic upgrade head` to apply pending migrations

**Error: "FAILED: Multiple head revisions are present"**
- Merge heads: `alembic merge heads -m "merge heads"`

## Migration Workflow

1. Make changes to SQLAlchemy models in `app/models/`
2. Generate migration: `alembic revision --autogenerate -m "add user email field"`
3. Review the generated file in `alembic/versions/`
4. Edit if necessary (add data migrations, etc.)
5. Test: `alembic upgrade head`
6. Verify: Check database schema
7. Commit migration file to git

## Additional Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [Alembic Tutorial](https://alembic.sqlalchemy.org/en/latest/tutorial.html)
